<html>
  <head>
    <script>
      function ready() {
        console.log("ready");
        const videoTag = document.getElementById("my-video");
        const myMediaSource = new MediaSource();

        // 1. add source buffers
        myMediaSource.addEventListener("sourceopen", sourceOpen);

        // const audioSourceBuffer = myMediaSource
        // .addSourceBuffer('audio/mp4; codecs="mp4a.40.2"')
        function sourceOpen() {
          var videoSourceBuffer = myMediaSource.addSourceBuffer(
            'video/mp4; codecs="avc1.64001e"'
          );
          videoSourceBuffer.addEventListener("updateend", function (_) {
            myMediaSource.endOfStream();
            video.play();
            console.log(mediaSource.readyState); // ended
          });

          const ws = new WebSocket("ws://localhost:9999/ws");
          const initWebsocket = () => {
            ws.onopen = () => {
              //   ws.send(JSON.stringify(subscription));
              console.log("open");
            };
            ws.onmessage = (event) => {
              event.data.arrayBuffer().then((data) => {
                videoSourceBuffer.appendBuffer(data);
              });
              //   const response = JSON.parse(event.data);
              //   switch (response.event) {
              //     case "data":
              //       console.log("data");
              //       break;
              //     case "bts:request_reconnect":
              //       //   initWebsocket();
              //       console.log("request reconnect");
              //       break;
              //     default:
              //       break;
              //   }
            };
            ws.onclose = () => {
              //   initWebsocket();
              console.log("closing");
            };
          };
          initWebsocket();
          ws.send("hello");
        }
        const url = URL.createObjectURL(myMediaSource);
        videoTag.src = url;
      }
      window.addEventListener("DOMContentLoaded", function () {
        console.log("All assets are loaded");
        ready();
      });
    </script>
  </head>
  <body>
    <h1>Hello world</h1>
    <video id="my-video"></video>
  </body>
</html>
