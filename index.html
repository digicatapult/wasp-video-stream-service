<html>
<head>
</head>
<body>
<video id="video" autoPlay="true" muted="muted"></video>
<script>
function ready() {
    const video = document.getElementById("video");
    const ws = new WebSocket('ws://localhost:9999/ws');
    const mimeCodec = 'video/mp4; codecs="avc1.64001e, mp4a.40.2"';
    const arrayOfBlobs = [];
    const mediaSource = new MediaSource();

    const url = URL.createObjectURL(mediaSource);
    video.src = url;

    let sourceBuffer = null;
    mediaSource.addEventListener("sourceopen", function () {
        video.play();

        sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);
        sourceBuffer.addEventListener("update", appendToSourceBuffer);
    });

    function appendToSourceBuffer() {
        if (arrayOfBlobs.length > 0 && !arrayOfBlobs.updating) {
            arrayOfBlobs.appendBuffer(arrayOfBlobs.shift());
        }
    }

    ws.onopen = () => {
        ws.onmessage = (event) => {
            const videoUrl = window.URL.createObjectURL(event.data);

            get(videoUrl, (buffer) => {
                if (buffer && buffer.length > 0) {
                    arrayOfBlobs.append(buffer);

                    appendToSourceBuffer();
                }
            });
        }
    }

    function get(url, callback) {
        const xhr = new XMLHttpRequest();
        xhr.open('get', url, true);
        xhr.responseType = 'arraybuffer';
        xhr.send();

        xhr.onload = () => {
            callback(xhr.response);
        };
    }
}

window.addEventListener("DOMContentLoaded", function () {
    console.log("Loaded");
    ready();
});
</script>
</body>
</html>